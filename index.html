<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>體感打排球遊戲系統</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --c-pink: #ff00de; --c-cyan: #00fff2; --c-yellow: #eeff00;
        --c-p1: #00fff2; --c-p2: #ff00de; --c-bg: #120421; --c-glass: rgba(255, 255, 255, 0.1);
    }
    body {
        margin: 0; background: var(--c-bg); color: #fff;
        font-family: 'Segoe UI', sans-serif; overflow: hidden;
        height: 100vh; width: 100vw; user-select: none; touch-action: none;
    }
    /* Layers */
    #game-wrapper, #mirror-layer, #game-canvas, #ui-layer { position: absolute; inset: 0; }
    #mirror-layer { transform: scaleX(-1); z-index: 1; }
    #game-canvas { z-index: 2; }
    #ui-layer { z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
    
    video { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: contrast(1.2) brightness(0.8) hue-rotate(20deg); }
    canvas { width: 100%; height: 100%; }
    .bg-deco {
        position: absolute; inset: 0; z-index: 0;
        background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 30px 30px; opacity: 0.5;
    }

    /* UI Components */
    #top-bar {
        padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
        background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); pointer-events: auto;
    }
    .score-single { font-size: 48px; font-weight: 900; color: var(--c-yellow); text-shadow: 0 0 15px var(--c-yellow); font-style: italic; }
    
    .score-vs-box {
        background: var(--c-glass); padding: 5px 25px; border-radius: 50px;
        border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px);
        display: flex; flex-direction: column; align-items: center; box-shadow: 0 0 20px rgba(0,255,242,0.2);
    }
    .score-vs-nums { font-size: 42px; font-weight: 900; display: flex; gap: 20px; }
    .p1-s { color: var(--c-p1); text-shadow: 0 0 15px var(--c-p1); }
    .p2-s { color: var(--c-p2); text-shadow: 0 0 15px var(--c-p2); }
    .vs-label { font-size: 14px; opacity: 0.8; font-weight: bold; margin-top: -5px; }

    .lives-box { display: flex; gap: 5px; }
    .heart { color: var(--c-pink); font-size: 30px; filter: drop-shadow(0 0 8px var(--c-pink)); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }

    #sound-btn {
        background: rgba(255,255,255,0.2); border: 2px solid #fff; color: #fff;
        width: 44px; height: 44px; border-radius: 50%; cursor: pointer;
        display: flex; justify-content: center; align-items: center;
        font-size: 18px; transition: 0.2s; box-shadow: 0 0 10px rgba(255,255,255,0.3);
    }
    #sound-btn:hover { background: #fff; color: var(--c-bg); transform: scale(1.1); }

    /* Panel & Buttons */
    .panel {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(20, 10, 40, 0.9); border: 2px solid var(--c-cyan);
        padding: 40px; border-radius: 25px; text-align: center;
        box-shadow: 0 0 60px rgba(0,255,242,0.4); width: 90%; max-width: 420px;
        backdrop-filter: blur(15px); pointer-events: auto;
    }
    .panel h1 { 
        margin: 0 0 20px; 
        /* Responsive Single Line Logic */
        font-size: clamp(20px, 7vw, 40px); 
        white-space: nowrap; 
        font-style: italic; letter-spacing: 1px;
        text-shadow: 3px 3px 0px var(--c-pink), -3px -3px 0px var(--c-cyan);
    }
    .panel p { font-size: 1.2rem; margin-bottom: 25px; color: #ddd; }
    
    .btn {
        display: block; width: 100%; padding: 18px; margin: 12px 0; border: none; border-radius: 50px;
        font-size: 20px; font-weight: 800; cursor: pointer; color: #000;
        transition: transform 0.1s, filter 0.2s; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
    .btn:active { transform: scale(0.95); }
    
    .btn-solo { background: linear-gradient(90deg, var(--c-cyan), #00a8ff); }
    .btn-vs { background: linear-gradient(90deg, var(--c-pink), #ff5e57); }
    .btn-restart { background: linear-gradient(90deg, var(--c-yellow), #0be881); }
    .btn-home { background: #dcdde1; }
    
    .hidden { display: none !important; }
    .mascot-container { position: absolute; bottom: 30px; left: 20px; width: 110px; z-index: 30; pointer-events: auto; }
    .mascot-container img { width: 100%; filter: drop-shadow(0 0 15px rgba(255,255,255,0.4)); }
    .mascot-container:hover img { animation: shake 0.5s infinite; }
    @keyframes shake { 0%{transform:rotate(0deg);} 25%{transform:rotate(-10deg);} 75%{transform:rotate(10deg);} }
    .footer { position: absolute; bottom: 8px; width: 100%; text-align: center; font-size: 11px; color: rgba(255,255,255,0.5); }
</style>
</head>
<body>
    <div class="bg-deco"></div>
    <div id="game-wrapper">
        <div id="mirror-layer">
            <video id="vid" autoplay playsinline muted></video>
            <canvas id="motion-cvs"></canvas>
        </div>
        <canvas id="game-canvas"></canvas>
    </div>
    
    <div id="ui-layer">
        <div id="top-bar">
            <div style="display:flex; align-items:center; gap:15px;">
                <button id="sound-btn" onclick="sfx.toggle()"><i class="fas fa-volume-up"></i></button>
                <div id="ui-single" class="score-single hidden"><i class="fas fa-star"></i> <span id="scoreVal">0</span></div>
                <div id="ui-vs" class="score-vs-box hidden">
                    <div class="score-vs-nums">
                        <span class="p1-s" id="p1Val">0</span><span style="opacity:0.5">:</span><span class="p2-s" id="p2Val">0</span>
                    </div>
                    <div class="vs-label">TARGET: 5</div>
                </div>
            </div>
            <div id="ui-lives" class="lives-box hidden"></div>
        </div>
        <div class="mascot-container">
            <img src="image/LiyuChillGuy.svg" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Git-logo.svg/200px-Git-logo.svg.png'" alt="Mascot">
        </div>
        <div class="footer">Copyright © Liyuchiutiger Gongminshen</div>

        <div class="panel" id="p-start">
            <h1>體感打排球遊戲系統</h1>
            <p>請選擇遊戲模式</p>
            <button class="btn btn-solo" onclick="initGame('single')"><i class="fas fa-user"></i> 單人挑戰</button>
            <button class="btn btn-vs" onclick="initGame('multi')"><i class="fas fa-user-friends"></i> 雙人對戰</button>
        </div>

        <div class="panel hidden" id="p-end">
            <h1 id="end-title" style="font-size: clamp(2.5rem, 8vw, 3.5rem);">GAME OVER</h1>
            <p id="end-desc">SCORE</p>
            <h2 id="end-score" style="font-size: 5rem; margin: 10px 0; text-shadow:0 0 30px #fff;">0</h2>
            <button class="btn btn-restart" onclick="restartGame()">再玩一次</button>
            <button class="btn btn-home" onclick="showHome()">主選單</button>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const vid = $('vid');
        const mCvs = $('motion-cvs'), mCtx = mCvs.getContext('2d');
        const gCvs = $('game-canvas'), gCtx = gCvs.getContext('2d');
        const tmpCvs = document.createElement('canvas'), tmpCtx = tmpCvs.getContext('2d', { willReadFrequently: true });
        
        let w, h, ch;
        let prevData = null;
        let gameActive = false, gameMode = 'single', roundOver = false;
        let score = 0, lives = 3, p1Score = 0, p2Score = 0;
        let shake = 0, particles = [];
        let ball;
        
        const CFG = { cw: 64, thresh: 25, gravity: 0.5, friction: 0.99, bounce: -17, wall: 0.7, winTarget: 5 };

        // Sound System
        const sfx = {
            ctx: null, muted: false,
            init() { 
                if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); 
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            toggle() { 
                this.muted = !this.muted; 
                $('sound-btn').innerHTML = this.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            play(freq, type, dur, vol=0.3) {
                if(!this.ctx || this.muted) return;
                const o = this.ctx.createOscillator(), g = this.ctx.createGain();
                o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
                g.gain.setValueAtTime(vol, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+dur);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime+dur);
            },
            hit() { this.play(200, 'square', 0.1, 0.6); },
            bounce() { this.play(300, 'sine', 0.1, 0.4); },
            point() { this.play(600, 'sine', 0.1, 0.4); setTimeout(()=>this.play(800, 'sine', 0.2, 0.4), 100); },
            fail() { this.play(150, 'sawtooth', 0.4, 0.6); },
            win() { [0,150,300,450,600].forEach((t,i) => setTimeout(()=>this.play(400+i*100, 'square', 0.2, 0.5), t)); }
        };

        // Game Objects
        const net = {
            draw(ctx) {
                const nx = w/2, ny = h*0.6;
                ctx.save();
                ctx.shadowBlur=10; ctx.shadowColor="#fff"; ctx.strokeStyle="rgba(255,255,255,0.6)";
                ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(nx, h); ctx.lineTo(nx, ny); ctx.stroke();
                ctx.lineWidth=2; ctx.beginPath();
                for(let i=ny; i<h; i+=25) { ctx.moveTo(nx-8, i); ctx.lineTo(nx+8, i); }
                ctx.stroke();
                ctx.fillStyle="#00fff2"; ctx.fillRect(nx-8, ny, 16, 6);
                ctx.restore();
            },
            check(b) {
                const nx = w/2, ny = h*0.6;
                if(b.y+b.r > ny && b.y < ny+20 && Math.abs(b.x-nx) < b.r+8) {
                    if(b.vy > 0) { b.y = ny-b.r; b.vy *= -0.8; sfx.bounce(); }
                }
                if(b.y > ny && Math.abs(b.x-nx) < b.r+8) {
                    b.vx *= -0.8; b.x = (b.x < nx) ? nx-b.r-8 : nx+b.r+8; sfx.bounce();
                }
            }
        };

        class Ball {
            constructor() { this.reset(); }
            reset(side) {
                this.r = 38; this.x = side==='left' ? w*0.25 : (side==='right' ? w*0.75 : w/2);
                this.y = 100; this.vx = (Math.random()-0.5)*8; this.vy = 0; this.rot = 0;
                roundOver = false;
            }
            update() {
                if(roundOver) return;
                this.vy += CFG.gravity; this.vx *= CFG.friction;
                this.x += this.vx; this.y += this.vy; this.rot += this.vx * 0.05;

                if(this.x-this.r<0) { this.x=this.r; this.vx*=-CFG.wall; sfx.bounce(); }
                if(this.x+this.r>w) { this.x=w-this.r; this.vx*=-CFG.wall; sfx.bounce(); }
                if(this.y-this.r<-300) { this.y=-300+this.r; this.vy=Math.abs(this.vy)*0.5; }
                if(gameMode==='multi') net.check(this);
            }
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y); ctx.rotate(this.rot);
                ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.clip();
                
                ctx.fillStyle="#fff"; ctx.fill();
                const colors = ["#ff00de", "#00fff2", "#eeff00"];
                const paths = [
                    [[-1, -0.2], [-0.3, -0.2, 0, -0.5, 0.8, -1], [-1, -1]],
                    [[1, 0.2], [0.3, 0.2, 0, 0.5, -0.8, 1], [1, 1]],
                    [[-1, -0.2], [-0.1, 0, -0.1, 0.5, -0.5, 1], [-1, 1], [-1, 0]]
                ];
                paths.forEach((p, i) => {
                    ctx.fillStyle = colors[i]; ctx.beginPath(); ctx.moveTo(p[0][0]*this.r, p[0][1]*this.r);
                    if(p.length===3) ctx.bezierCurveTo(p[1][0]*this.r, p[1][1]*this.r, p[1][2]*this.r, p[1][3]*this.r, p[1][4]*this.r, p[1][5]*this.r);
                    else ctx.bezierCurveTo(p[1][0]*this.r, p[1][1]*this.r, p[1][2]*this.r, p[1][3]*this.r, p[1][4]*this.r, p[1][5]*this.r);
                    for(let j=2; j<p.length; j++) ctx.lineTo(p[j][0]*this.r, p[j][1]*this.r);
                    ctx.fill();
                });
                
                ctx.restore(); ctx.save(); ctx.translate(this.x, this.y);
                ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2);
                ctx.lineWidth=3; ctx.strokeStyle="rgba(255,255,255,0.8)"; 
                ctx.shadowColor="#fff"; ctx.shadowBlur=15; ctx.stroke();
                ctx.fillStyle="rgba(255,255,255,0.4)";
                ctx.beginPath(); ctx.arc(-this.r*0.3, -this.r*0.3, this.r*0.2, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            }
            hit(px) {
                this.vy = CFG.bounce;
                let dx = this.x - px;
                this.vx += dx * 0.3; this.vx = Math.max(-15, Math.min(15, this.vx)); 
                sfx.hit(); shake = 5;
                spawnParticles(this.x, this.y, 15, ['#ff00de', '#00fff2', '#eeff00']);
            }
        }

        class Particle {
            constructor(x, y, cols, isConfetti=false) {
                this.x = x; this.y = y; this.col = cols[Math.floor(Math.random()*cols.length)];
                this.isConfetti = isConfetti;
                if(isConfetti) {
                    this.vx = (Math.random()-0.5)*12; this.vy = (Math.random()-0.5)*15 - 5;
                    this.life = 1.5; this.sz = Math.random()*8+5; this.g = 0.2;
                } else {
                    this.vx = (Math.random()-0.5)*10; this.vy = (Math.random()-0.5)*10;
                    this.life = 0.8; this.sz = Math.random()*6+3; this.g = 0;
                }
            }
            update() {
                this.vy += this.g; this.x += this.vx; this.y += this.vy;
                if(this.isConfetti) { this.vx*=0.96; this.life-=0.01; } else { this.life-=0.03; this.sz*=0.9; }
            }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.col;
                ctx.shadowColor = this.col; ctx.shadowBlur = 10; ctx.translate(this.x, this.y);
                if(this.isConfetti) ctx.fillRect(-this.sz/2, -this.sz/2, this.sz, this.sz);
                else { ctx.beginPath(); ctx.arc(0,0,this.sz,0,Math.PI*2); ctx.fill(); }
                ctx.restore();
            }
        }

        function spawnParticles(x, y, count, cols, isConfetti) { for(let i=0; i<count; i++) particles.push(new Particle(x, y, cols, isConfetti)); }
        
        function resize() {
            w = window.innerWidth; h = window.innerHeight;
            mCvs.width=gCvs.width=w; mCvs.height=gCvs.height=h;
            if(vid.videoWidth) { ch = Math.floor(CFG.cw * (vid.videoHeight/vid.videoWidth)); tmpCvs.width=CFG.cw; tmpCvs.height=ch; }
        }
        window.onresize = resize;

        async function initGame(mode) {
            gameMode = mode; sfx.init();
            try {
                const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},audio:false});
                vid.srcObject = s;
                vid.onloadedmetadata = () => { vid.play(); resize(); ball=new Ball(); startGame(); };
            } catch(e) { alert("無法啟動相機"); }
        }

        function startGame() {
            $('p-start').classList.add('hidden'); $('p-end').classList.add('hidden');
            score = 0; lives = 3; p1Score = 0; p2Score = 0; particles = [];
            if(gameMode === 'single') {
                $('ui-single').classList.remove('hidden'); $('ui-vs').classList.add('hidden'); $('ui-lives').classList.remove('hidden');
                updateLives();
            } else {
                $('ui-single').classList.add('hidden'); $('ui-vs').classList.remove('hidden'); $('ui-lives').classList.add('hidden');
            }
            updateScore(); ball.reset(); gameActive = true; loop();
        }

        function updateScore() { $('scoreVal').innerText = score; $('p1Val').innerText = p1Score; $('p2Val').innerText = p2Score; }
        function updateLives() { $('ui-lives').innerHTML = Array(lives).fill('<i class="fas fa-heart heart"></i>').join(''); }

        function handleFloor() {
            if(roundOver) return;
            roundOver = true; shake = 10;
            if(gameMode === 'single') {
                lives--; sfx.fail(); spawnParticles(ball.x, h-20, 20, ['#ff00de']); updateLives();
                if(lives <= 0) gameOver(); else setTimeout(() => ball.reset(), 800);
            } else {
                let winner = (ball.x > w/2) ? 1 : 2; 
                winner === 1 ? p1Score++ : p2Score++;
                spawnParticles(ball.x, h-20, 30, [winner===1?'#00fff2':'#ff00de', '#fff']);
                sfx.point(); updateScore();
                if(p1Score >= CFG.winTarget || p2Score >= CFG.winTarget) gameOver();
                else setTimeout(() => ball.reset(winner===1?'right':'left'), 1000);
            }
        }

        function gameOver() {
            gameActive = false;
            if(gameMode === 'single') {
                $('end-title').innerText = "GAME OVER"; $('end-desc').innerText = "FINAL SCORE"; $('end-score').innerText = score;
            } else {
                sfx.win(); spawnParticles(w/2, h/2, 100, ['#ff00de', '#00fff2', '#eeff00'], true);
                let p1Wins = p1Score > p2Score;
                $('end-title').innerText = p1Wins ? "P1 WIN!" : "P2 WIN!";
                $('end-title').style.color = p1Wins ? "var(--c-p1)" : "var(--c-p2)";
                $('end-desc').innerText = "VICTORY"; $('end-score').innerText = `${p1Score}-${p2Score}`;
            }
            setTimeout(() => $('p-end').classList.remove('hidden'), 500);
        }

        function restartGame() { sfx.point(); startGame(); }
        function showHome() { gameActive = false; $('p-end').classList.add('hidden'); $('p-start').classList.remove('hidden'); }

        function loop() {
            if(!gameActive && particles.length===0) return;
            if(vid.videoWidth) {
                tmpCtx.drawImage(vid, 0, 0, CFG.cw, ch);
                const d = tmpCtx.getImageData(0,0,CFG.cw,ch).data;
                mCtx.clearRect(0,0,w,h); mCtx.fillStyle = "rgba(0, 255, 242, 0.15)";
                if(prevData) {
                    for(let y=0; y<ch; y++) {
                        for(let x=0; x<CFG.cw; x++) {
                            if(Math.abs(d[(y*CFG.cw+x)*4+1]-prevData[(y*CFG.cw+x)*4+1]) > CFG.thresh) {
                                let rx = (CFG.cw-x-1)*(w/CFG.cw), ry = y*(h/ch);
                                mCtx.fillRect(rx, ry, w/CFG.cw, h/ch);
                                if(gameActive && !roundOver && ball.vy > -5 && (ball.x-rx)**2+(ball.y-ry)**2<(ball.r+25)**2) {
                                    ball.hit(rx); if(gameMode === 'single') { score++; updateScore(); }
                                }
                            }
                        }
                    }
                }
                prevData = d;
            }

            gCtx.clearRect(0,0,w,h); gCtx.save();
            if(shake > 0) { gCtx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; if(shake<0.5) shake=0; }
            if(gameMode === 'multi') net.draw(gCtx);
            if(gameActive) { ball.update(); ball.draw(gCtx); if(ball.y-ball.r > h) handleFloor(); }
            
            for(let i=particles.length-1; i>=0; i--) { 
                particles[i].update(); particles[i].draw(gCtx); 
                if(particles[i].life<=0) particles.splice(i,1); 
            }
            gCtx.restore(); requestAnimationFrame(loop);
        }
    </script>
</body>
</html>